name: Integration Tests

on:
  workflow_run:
    workflows:
      - Backend CI
      - CLI CI
    types:
      - completed
  push:
    paths:
      - .github/workflows/integration-tests.yml
      - integration-tests/**
  pull_request:
    paths:
      - .github/workflows/integration-tests.yml
      - integration-tests/**

permissions:
  contents: read
  actions: read

jobs:
  run-integration-tests:
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    env:
      GH_ACCESS_TOKEN_1: ${{ secrets.GH_ACCESS_TOKEN_1 }}
      GH_ACCESS_TOKEN_2: ${{ secrets.GH_ACCESS_TOKEN_2 }}
    defaults:
      run:
        working-directory: integration-tests

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Get latest CLI CI run
        id: get_cli_run
        uses: actions/github-script@v7
        with:
          script: |
            const workflowFile = "cli-ci.yml";
            const { owner, repo } = context.repo;

            const { data: workflow } = await github.rest.actions.getWorkflow({
              owner,
              repo,
              workflow_id: workflowFile,
            });

            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: workflow.id,
              status: "success",
              per_page: 1,
            });

            if (!runs.workflow_runs.length) {
              core.setFailed(`No successful runs found for ${workflowFile}.`);
              return;
            }

            core.setOutput("run-id", runs.workflow_runs[0].id.toString());

      - name: Download CLI artifact
        uses: actions/download-artifact@v4
        with:
          name: cli-binary
          path: integration-tests/cli-binary
          run-id: ${{ steps.get_cli_run.outputs.run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run integration tests
        run: pytest

